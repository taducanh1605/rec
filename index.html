<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RECORD-REPLAY</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: bisque;
            max-height: 99vh;
        }

        .butStop {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: rgba(0, 195, 255, 0.855);
            color: white;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s ease-in-out;
        }

        .butStop:hover {
            transform: scale(1.1);
        }

        .butStart {
            position: relative;
            display: inline-block;
            width: 150px;
            height: 150px;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            background-color: transparent !important;
        }

        .butStart::before,
        .butStart::after {
            content: "";
            position: absolute;
            width: 37px;
            height: 150px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgb(222, 91, 91);
        }

        .butStart::before {
            transform: translate(-50%, -50%) rotate(45deg);
        }

        .butStart::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }

        .butStart:hover {
            transform: scale(1.1);
        }

        .recording {
            background-color: red;
        }
    </style>
</head>

<body>
    <div id="start-button" class="butStart" onclick="handleButStart(this)"></div>
    <!-- <div id="stop-button">REPEAT</div> -->
    <script>
        window.flagS = 0;

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                // tạo một đối tượng MediaRecorder để ghi âm
                window.mediaRecorder = new MediaRecorder(stream);

                // [2023-04-10-DA] tạo đối tượng phân tích
                window.audioContext = new AudioContext();
                window.source = audioContext.createMediaStreamSource(stream);
                window.analyser = audioContext.createAnalyser();

                // [2023-04-10-DA] tạo buffer
                window.bufferSize = 2048;
                window.thresholdStop = 0.5;
                window.thresholdStart = 20;
                window.buffer = new Uint8Array(bufferSize);

                window.source.connect(analyser);

                // lưu các phân đoạn âm thanh được ghi lại
                window.mediaRecorder.addEventListener("dataavailable", event => { window.audioChunks.push(event.data); });

                // kết thúc ghi âm và lưu tệp WAV
                window.mediaRecorder.addEventListener("stop", () => {
                    let audioBlob = new Blob(window.audioChunks, { type: "audio/wav" });
                    let audioUrl = URL.createObjectURL(audioBlob);
                    window.audio = new Audio(audioUrl);
                    window.audio.addEventListener("ended", () => {
                        handleButStart(document.getElementById("start-button"));
                    });
                    window.audio.play();
                });

                handleButStart(document.getElementById("start-button"));
            });

        // bắt đầu ghi âm
        startRecording = function () {
            delete window.audio;
            window.audioChunks = [];
            window.mediaRecorder.start();
            window.count = 0;
            window.aS = setTimeout(autoStop, 1000);
        }

        // dừng ghi âm khi người dùng nhấn vào nút dừng ghi âm
        stopRecording = function () {
            window.flagS = 0;
            var sBut = document.getElementById("start-button");
            sBut.classList.remove("butStop");
            sBut.classList.add("butStart");

            if (window.aSt) clearTimeout(window.aSt);
            if (window.aS) clearTimeout(window.aS);
            if (!window.audio) window.mediaRecorder.stop();
            else window.audio.play();
        }

        // [2023-04-10-DA] autoStop
        autoStop = function () {
            if (window.count > 10) {
                stopRecording();
                return;
            }
            window.analyser.getByteFrequencyData(window.buffer);
            var volume = window.buffer.reduce((acc, val) => acc + val, 0) / bufferSize;
            if (volume < window.thresholdStop)
                window.count++;
            else
                window.count = 0;
            window.aS = setTimeout(autoStop, 70);
        }

        // [2023-04-10-DA] autoStart
        autoStart = function () {
            var butS = document.getElementById("start-button");
            butS.classList.remove("recording");
            window.analyser.getByteFrequencyData(window.buffer);
            var volume = window.buffer.reduce((acc, val) => acc + val, 0) / bufferSize;
            if (volume > window.thresholdStart) {
                if (window.aSt) clearTimeout(window.aSt);
                butS.classList.add("recording");
                startRecording();
            } else
                window.aSt = setTimeout(autoStart, 5);
        }

        handleButStart = function (that) {
            window.flagS = (window.flagS > 0) ? 0 : 1;

            if (window.flagS > 0) {
                that.classList.remove("butStart");
                that.classList.add("butStop");
                autoStart();
            } else
                stopRecording();
        }
    </script>
</body>

</html>